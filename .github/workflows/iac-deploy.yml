name: IaC Deploy (Bicep + Security Scan)

on:
  push:
    paths:
      - "bicep/**"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ① コードチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # ② Trivy で IaC（Bicep）セキュリティスキャン
      #     - 無料
      #     - 重大度 HIGH / CRITICAL のみ出力
      #     - exit-code=0 なので検出してもジョブは失敗しない（発表向けに安全設定）
      - name: Security Scan (IaC with Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: ./bicep
          exit-code: 0
          severity: HIGH,CRITICAL

      # ③ Azure ログイン（Service Principal 認証）
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          auth-type: SERVICE_PRINCIPAL

      # ④ Bicep の構文検証
      - name: Validate Bicep templates
        run: |
          az bicep build --file bicep/main.bicep

      # ⑤ what-if で差分確認（Dry-run）
      - name: What-if (Dry-run)
        run: |
          az deployment group what-if \
            --resource-group wiz-exercise-rg \
            --template-file bicep/main.bicep

      # ⑥ 実デプロイ（安全モード）
      - name: Deploy IaC to Azure
        run: |
          az deployment group create \
            --resource-group wiz-exercise-rg \
            --template-file bicep/main.bicep \
            --mode Incremental
